import sys
import os

import gensim
import pickle



malware_train_docs = dict()
malware_train_dir = 'parsed_malware'
for root, dirs, filenames in os.walk(malware_train_dir):
        for malware in filenames:
                malware_train_docs[malware] = open(os.path.join(root, malware), 'r').read().splitlines()                


vocabulary = []
for malware in malware_train_docs:
        vocabulary.append(malware_train_docs[malware])


model = gensim.models.Word2Vec(vocabulary, workers=8, sg=1, window=5, min_count=1)
print('vocabulary size  =  ' + str(len(model.wv.vocab)))


print('calculating distances...\n')
distances = dict()
bad_malwares = []
for root, dirs, filenames in os.walk(malware_train_dir):
    for test_malware in filenames:
        if test_malware in bad_malwares:
                continue
        malware_test_doc = open(os.path.join(root, test_malware), 'r').read().splitlines()
        print('test malware document size  =  ' + str(len(list(set(malware_test_doc)))))
        distances[test_malware] = dict()
        train_malwares = filenames[:]
        train_malwares.remove(test_malware)
        for malware in train_malwares:
                if malware in bad_malwares:
                        continue
                try:
                        distance = model.wmdistance(malware_train_docs[malware], malware_test_doc)
                        distances[test_malware][malware] = distance
                        print('test malware distance from ' + malware + '  =  ' + str(distance))
                except UnicodeDecodeError as err:
                        if err.object in malware_train_docs[malware]:
                                bad_malwares.append(malware)
                        else:
                                bad_malwares.append(test_malware)
        print('finished calculating distances for ' + test_malware)


## write distances dictionary to file
with open('distances.pickle', 'wb') as handle:
        pickle.dump(distances, handle, protocol=pickle.HIGHEST_PROTOCOL)
