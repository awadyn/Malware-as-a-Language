#!/bin/bash

#### psuedo-parses all malware assembly code
#### genertes text like files of opcode sequences

SOURCE_DIR="malware_by_class"
#DESTINATION_DIR="new_experiments/parsed_malwares"
DESTINATION_DIR="parsed_malware"

ASSEMBLY_TO_HEX="assembly_hex.txt"
ASSEMBLY="assembly.txt"
LOG_FILE="logs.txt"

class=$1



# create destination directories if they do not exist 
[[ -d ${DESTINATION_DIR} ]] || mkdir ${DESTINATION_DIR}



# remove pre-existing log file
rm "${LOG_FILE}"

        

echo
echo "Parsing malware assembly files."
echo

INPUT_DIR="${SOURCE_DIR}/${class}"
COUNTER=1
for file in "${INPUT_DIR}/"*.asm;
do
        echo "... parsing ${file}"

	    # remove assembly code, keeping only .text code region
	    # delete all lines that begin with "HEADER"; this code refers to static information regarding the malware; we are not concerned with static analysis at the moment
	    # delete all lines that begin with ".idata", ".edata", ".rdata", ".data", ".bss"; this code refers to non-stack variables; we are not concerned with variables at the moment
	    # delete all lines that begin with ".rsrc"
	    # delete all lines that begin with ".debug"
	    # parse ".text" region:	remove all comments;
	    #			keep only text assembly instructions with specified opcodes;
	    # 			format syntax: remove leading and trailing whitespaces and new lines; collapse all spaces



# slow method:
#	sed -n "/HEADER/ d; /.idata/ d; /.edata/ d; /.rdata/ d; /.data/ d; /.bss/ d; /.rsrc/ d; /.debug/ d; s/\;.*//g; $(sed 's:.*:s/.*  *\\(&  .* *\\)/\\1/p:' assembly.txt)" "${file} >> "${DESTINATION_DIR}/malware_lang_${class}_${COUNTER}"



# faster method:
	    sed -n "/HEADER/ d; /.idata/ d; /.edata/ d; /.rdata/ d; /.data/ d; /.bss/ d; /.rsrc/ d; /.debug/ d; s/\;.*//g; $(sed 's:.*:/  &  / p:' assembly.txt);" "${file}" >> "${DESTINATION_DIR}/malware_lang_${class}_${COUNTER}"
        sed -i "$(sed 's:.*:s/.*  &  /&/g:' assembly.txt); s/^[ \t]*//; s/[ \t]*$//; s/[ \t]\+/ /g; s/,[ \t]*/./g; s/ /./g; s/eax/gpr/g; s/ebx/gpr/g; s/ecx/gpr/g; s/edx/gpr/g; s/\[gpr.*\]/gpr/g; s/\[esp.*\]/esp/g; s/\[ebp.*\]/ebp/g; s/\[esi.*\]/esi/g; s/\[edi.*\]/edi/g; s/call.*/call/g; s/jmp.*/jmp/g; s/\([[:alpha:]]\+[[:digit:]]\+[[:alnum:]]*\|[[:digit:]]\+[[:alpha:]]\+[[:alnum:]]*\) \?/const/g; s/[[:digit:]]\+/const/g; s/offset.*/offset/g; s/[:;±§+=?!@\#\$\"\'|%^&*\(\){}<>/~,_-]//g" "${DESTINATION_DIR}/malware_lang_${class}_${COUNTER}"

        echo "done."
        let COUNTER=${COUNTER}+1
done


